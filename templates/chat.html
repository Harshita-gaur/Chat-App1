{% load static %}

<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <link rel="stylesheet" href="{% static 'css/chat.css' %}">
</head>
<body>
    <div class="navbar">
        <a href="#">Home</a>
        <a href="#">About</a>
        <a href="#">Contact</a>
    </div>
    <h2>Welcome, {{ user.username }}</h2>
    
    <div class="container">
        <div class="left-menu">
            <h3>Users</h3>
            {% if receiver %}
                <li>
                    <div class="change-button">
                        <a href="{% url 'chat' %}">Change receiver</a>
                    </div>
                </li>
            {% else %}
                <ul>
                    {% for user in users %}
                        <li><a href="{% url 'chat_with_user' receiver_id=user.username %}">{{ user.username }}</a></li>
                    {% empty %}
                        <li>No users found</li>
                    {% endfor %}
                </ul>
            {% endif %}
            <li><div class="change-button"><a href="{% url 'logout' %}">Logout</a></div></li>
            <li>
                <div class="change-button">
                    <a href="{% url 'chat_with_group' sender_id=user.username %}">Group Chat</a>
                </div>
            </li>
        </div>

        <div class="main-content">
            <div class="collapsible-container">
                <div class="collapsible" onclick="toggleLeftMenu()">Toggle Left Menu</div>
                <div class="collapsible" onclick="toggleRightMenu()">Toggle Right Panel</div>
            </div>
            <div class="content-box">
                <h1>Messages with {% if receiver %}{{ receiver.username }}{% else %}everyone{% endif %}</h1>
                <ul id="messages">
                    {% for message in messages %}
                        <li>
                            <b>{{ message.sender.username }}</b>: {{ message.content }} 
                            <small>{{ message.timestamp }}</small>
                        </li>
                    {% empty %}
                        <li>No messages yet</li>
                    {% endfor %}
                </ul>
                <form method="POST" action="{% if receiver %}{% url 'send_message' receiver_id=receiver.username %}{% else %}{% url 'send_group_message' sender_id=sender.username %}{% endif %}">
                    {% csrf_token %}
                    <textarea name="content" placeholder="Type your message" required></textarea>
                    <button type="submit">Send</button>
                </form>
            </div>
        </div>
        
        <div class="right-panel">
            <div class="logout-section"></div>
        </div>
    </div>

    <div class="footer">
        Footer Content
    </div>

    <script>
        function toggleLeftMenu() {
            const leftMenu = document.querySelector('.left-menu');
            const mainContent = document.querySelector('.main-content');
            leftMenu.classList.toggle('collapsed');
            mainContent.style.marginLeft = leftMenu.classList.contains('collapsed') ? '0' : '200px';
        }

        function toggleRightMenu() {
            const rightPanel = document.querySelector('.right-panel');
            const mainContent = document.querySelector('.main-content');
            rightPanel.classList.toggle('collapsed');
            mainContent.style.marginRight = rightPanel.classList.contains('collapsed') ? '0' : '200px';
        }

        // Use 'group' if the receiver is None (group chat) otherwise use receiver.username for direct chat
        const roomId = "{{ receiver.username|default:'group' }}";

        const chatSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/chat/' + roomId + '/'
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const messageList = document.querySelector('#messages');
            const messageItem = document.createElement('li');
            messageItem.innerHTML = `<b>${data.sender}</b>: ${data.message} <small>${data.timestamp}</small>`;
            messageList.appendChild(messageItem);
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        document.querySelector('form').onsubmit = function(e) {
            e.preventDefault();
            const messageInput = document.querySelector('textarea[name="content"]');
            const messageContent = messageInput.value;
            chatSocket.send(JSON.stringify({ 'message': messageContent }));
            const messageList = document.querySelector('#messages');
            const messageItem = document.createElement('li');
            messageItem.innerHTML = `<b>You</b>: ${messageContent} <small>Just now</small>`;
            messageList.appendChild(messageItem);
            messageInput.value = '';
        };
    </script>
</body>
</html>
